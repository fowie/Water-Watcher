// Prisma schema for Water-Watcher
// Shared database between Next.js web app and Python scraping pipeline

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Rivers ───────────────────────────────────────────────

model River {
  id          String   @id @default(cuid())
  name        String
  state       String
  region      String?
  latitude    Float?
  longitude   Float?
  difficulty  String?  // e.g., "Class III-IV"
  description String?
  awId        String?  @unique @map("aw_id") // American Whitewater ID
  usgsGaugeId String?  @map("usgs_gauge_id") // USGS gauge station ID
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  conditions  RiverCondition[]
  hazards     Hazard[]
  campsites   Campsite[]
  rapids      Rapid[]
  trackedBy   UserRiver[]
  tripStops   TripStop[]
  reviews     RiverReview[]
  photos      RiverPhoto[]

  @@map("rivers")
}

model RiverCondition {
  id          String   @id @default(cuid())
  riverId     String   @map("river_id")
  flowRate    Float?   @map("flow_rate")    // CFS
  gaugeHeight Float?   @map("gauge_height") // feet
  waterTemp   Float?   @map("water_temp")   // fahrenheit
  quality     String?  // "excellent", "good", "fair", "poor", "dangerous"
  runnability String?  // "optimal", "runnable", "too_low", "too_high"
  source      String   // "usgs", "aw", "facebook", "blm", "usfs"
  sourceUrl   String?  @map("source_url")
  rawData     Json?    @map("raw_data")
  scrapedAt   DateTime @map("scraped_at")
  createdAt   DateTime @default(now()) @map("created_at")

  river River @relation(fields: [riverId], references: [id], onDelete: Cascade)

  @@index([riverId, scrapedAt])
  @@map("river_conditions")
}

model Hazard {
  id          String   @id @default(cuid())
  riverId     String   @map("river_id")
  type        String   // "strainer", "dam", "logjam", "rapid_change", "closure", "permit_required"
  severity    String   // "info", "warning", "danger"
  title       String
  description String?
  source      String
  sourceUrl   String?  @map("source_url")
  reportedAt  DateTime @map("reported_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  river River @relation(fields: [riverId], references: [id], onDelete: Cascade)

  @@index([riverId, isActive])
  @@map("hazards")
}

model Campsite {
  id          String   @id @default(cuid())
  riverId     String   @map("river_id")
  name        String
  latitude    Float?
  longitude   Float?
  type        String?  // "blm", "usfs", "private", "dispersed"
  amenities   String[] // ["fire_ring", "toilet", "water", "boat_ramp"]
  permitReq   Boolean  @default(false) @map("permit_required")
  description String?
  source      String
  sourceUrl   String?  @map("source_url")
  createdAt   DateTime @default(now()) @map("created_at")

  river River @relation(fields: [riverId], references: [id], onDelete: Cascade)

  @@map("campsites")
}

model Rapid {
  id          String   @id @default(cuid())
  riverId     String   @map("river_id")
  name        String
  difficulty  String?  // "Class II", "Class IV+"
  mile        Float?   // river mile marker
  description String?
  runGuide    String?  @map("run_guide") // how to run it
  source      String
  sourceUrl   String?  @map("source_url")
  createdAt   DateTime @default(now()) @map("created_at")

  river River @relation(fields: [riverId], references: [id], onDelete: Cascade)

  @@map("rapids")
}

// ─── Raft Watch (Gear Deals) ──────────────────────────────

model GearDeal {
  id          String   @id @default(cuid())
  title       String
  price       Float?
  url         String   @unique
  imageUrl    String?  @map("image_url")
  description String?
  category    String?  // "raft", "kayak", "paddle", "pfd", "drysuit", "other"
  region      String?  // craigslist region
  postedAt    DateTime? @map("posted_at")
  scrapedAt   DateTime @map("scraped_at")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  matchedFilters DealFilterMatch[]

  @@index([category, isActive])
  @@index([scrapedAt])
  @@map("gear_deals")
}

model DealFilter {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  keywords    String[] // search terms
  categories  String[] // gear categories to match
  maxPrice    Float?   @map("max_price")
  regions     String[] // craigslist regions
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  matches DealFilterMatch[]

  @@map("deal_filters")
}

model DealFilterMatch {
  id        String   @id @default(cuid())
  filterId  String   @map("filter_id")
  dealId    String   @map("deal_id")
  notified  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  filter DealFilter @relation(fields: [filterId], references: [id], onDelete: Cascade)
  deal   GearDeal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([filterId, dealId])
  @@map("deal_filter_matches")
}

// ─── Users & Auth ─────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  name          String?
  passwordHash  String?   @map("password_hash")
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          String    @default("user") // "user" or "admin"
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts      Account[]
  sessions      Session[]
  trackedRivers UserRiver[]
  dealFilters   DealFilter[]
  pushSubs      PushSubscription[]
  notificationPreference NotificationPreference?
  alertLogs     AlertLog[]
  trips         Trip[]
  reviews       RiverReview[]
  photos        RiverPhoto[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model UserRiver {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  riverId     String   @map("river_id")
  notify      Boolean  @default(true) // notify on condition changes
  createdAt   DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  river River @relation(fields: [riverId], references: [id], onDelete: Cascade)

  @@unique([userId, riverId])
  @@map("user_rivers")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}

// ─── Scraper Metadata ─────────────────────────────────────

model ScrapeLog {
  id         String   @id @default(cuid())
  source     String   // scraper name
  status     String   // "success", "error", "partial"
  itemCount  Int      @default(0) @map("item_count")
  error      String?
  duration   Int?     // milliseconds
  startedAt  DateTime @map("started_at")
  finishedAt DateTime? @map("finished_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([source, startedAt])
  @@map("scrape_logs")
}

// ─── Notification Preferences ──────────────────────────

model NotificationPreference {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  channel         String   @default("push") // "push", "email", "both"
  dealAlerts      Boolean  @default(true) @map("deal_alerts")
  conditionAlerts Boolean  @default(true) @map("condition_alerts")
  hazardAlerts    Boolean  @default(true) @map("hazard_alerts")
  weeklyDigest    Boolean  @default(false) @map("weekly_digest")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("notification_preferences")
}

// ─── Alert History ────────────────────────────────────

model AlertLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // "deal", "condition", "hazard", "digest"
  channel   String   // "push", "email"
  title     String
  body      String?
  metadata  Json?    // extra context (river_id, deal_ids, etc.)
  sentAt    DateTime @map("sent_at") @default(now())
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sentAt])
  @@map("alert_logs")
}

// ─── Trip Planner ─────────────────────────────────────

model Trip {
  id          String     @id @default(cuid())
  userId      String     @map("user_id")
  name        String
  startDate   DateTime   @map("start_date")
  endDate     DateTime   @map("end_date")
  status      String     @default("planning") // planning, active, completed, cancelled
  notes       String?
  isPublic    Boolean    @default(false) @map("is_public")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  stops       TripStop[]

  @@index([userId, startDate])
  @@map("trips")
}

model TripStop {
  id          String   @id @default(cuid())
  tripId      String   @map("trip_id")
  riverId     String   @map("river_id")
  dayNumber   Int      @map("day_number")
  notes       String?
  putInTime   String?  @map("put_in_time") // "08:00"
  takeOutTime String?  @map("take_out_time")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  river       River    @relation(fields: [riverId], references: [id], onDelete: Cascade)

  @@index([tripId, dayNumber])
  @@map("trip_stops")
}

// ─── River Photos ─────────────────────────────────────

model RiverPhoto {
  id          String   @id @default(cuid())
  riverId     String   @map("river_id")
  userId      String   @map("user_id")
  url         String   // stored photo URL or base64 data URL
  caption     String?
  takenAt     DateTime? @map("taken_at")
  createdAt   DateTime @default(now()) @map("created_at")

  river       River    @relation(fields: [riverId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([riverId, createdAt])
  @@map("river_photos")
}

// ─── River Reviews ────────────────────────────────────

model RiverReview {
  id          String   @id @default(cuid())
  riverId     String   @map("river_id")
  userId      String   @map("user_id")
  rating      Int      // 1-5 stars
  title       String?
  body        String
  visitDate   DateTime? @map("visit_date")
  difficulty  String?  // user's perceived difficulty
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  river       River    @relation(fields: [riverId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([riverId, userId]) // one review per river per user
  @@index([riverId, createdAt])
  @@map("river_reviews")
}
