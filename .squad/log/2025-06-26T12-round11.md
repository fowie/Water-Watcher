# Session Log — Round 11

**Date:** 2026-02-24  
**Round:** 11  
**Commit:** e4beaf6

## Summary

Round 11 added global search (command palette + dedicated page), a river photo gallery with lightbox and upload, and a scrape monitoring dashboard across backend, frontend, and testing.

**Backend (Utah):** Global Search API (`GET /api/search`) with Prisma case-insensitive `contains` matching across rivers, deals, trips, and reviews. Results grouped by type with auth-aware trip scoping — anonymous users get trips silently omitted on `type=all`, explicit `type=trips` returns 401. River Photo Gallery with `RiverPhoto` Prisma model: paginated public GET, auth+rate-limited POST (max 20 per user per river), owner-only DELETE. Scrape Monitoring API at `/api/admin/scrapers` (summary) and `/api/admin/scrapers/:source` (detail) — queries existing `ScrapeLog` model with no schema changes, returns per-source 24h stats and log history. All new models mirrored in SQLAlchemy.

**Frontend (Tyler):** Command palette (`SearchPalette`) triggered by Cmd/Ctrl+K or search icon in navigation — full-screen overlay with 300ms debounced input, grouped results by type, arrow key navigation, recent searches in localStorage. Dedicated `/search` page with type filter tabs and card grid. Photo gallery component with click-to-lightbox (keyboard nav, scroll lock), Intersection Observer lazy loading. Photo upload dialog with base64 data URL conversion, 5MB client-side limit, file preview. River detail tabs expanded from 6 to 7 columns (Photos tab with count badge). Scrape monitor dashboard at `/admin/scrapers` with traffic light health indicators (green <2x interval, yellow 2-3x, red >3x), expandable detail cards with scrape history tables.

**Testing (Pappas):** 96 new tests — search (32), photos (31), scrapers (33). Web tests: 572 → 668. Grand total: 1,347 (1,304 passed + 43 skipped). No bugs found. Observations: search `type=all` silently skips trips for anonymous users (correct but undocumented), scraper source validation is case-sensitive, photo upload rate limit runs before auth check.

## Metrics

| Service  | Passed | Skipped | Total |
|----------|--------|---------|-------|
| Pipeline | 636    | 43      | 679   |
| Web      | 668    | 0       | 668   |
| **All**  | **1304** | **43** | **1347** |

## Key Decisions

- **BD-028:** Global search uses Prisma `contains` (not full-text search); trips auth-aware; results grouped by type
- **BD-029:** River photos max 20 per user per river; base64 data URLs accepted; owner-only delete
- **BD-030:** Scrape monitoring queries existing ScrapeLog — no schema changes, query-time aggregation
- **FE-021:** Command palette (Cmd/Ctrl+K) with arrow-key navigation, recent searches in localStorage, Suspense boundary for search params
- **FE-022:** Base64 upload via FileReader.readAsDataURL; lightbox with vanilla DOM events; Intersection Observer lazy loading
- **FE-023:** River detail tabs expanded to 7 columns (added Photos with count badge)
- **FE-024:** Scraper health traffic light: green (<2x interval), yellow (2-3x), red (>3x); intervals hardcoded per source
- **TST-008:** 96 new tests covering search, photos, scrapers

## Open Items

- Search `type=all` silently skips trips for anonymous users — undocumented for API consumers
- Scraper stats `VALID_SOURCES` is case-sensitive — "USGS" returns 400
- Photo upload rate limit (`withRateLimit`) runs before auth (`withAuth`) — unauthenticated requests consume rate limit tokens
- SSE endpoint still unauthenticated (from Round 9)
- 43 Facebook scraper test stubs remain skipped (scraper not implemented)
- General API rate limiting (60/min default) not yet applied globally
- Reviews GET route lacks `sort` parameter (from Round 10)
- Map page requires lat/lng on RiverSummary (from Round 9)

## Commits

- `e4beaf6` — Round 11 features (global search, river photo gallery, scrape monitor, 96 tests)
