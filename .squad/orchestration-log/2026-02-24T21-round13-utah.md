# Orchestration Log — Utah (Backend Dev)

**Timestamp:** 2026-02-24T21:00:00Z
**Mode:** background
**Session:** round13

## Summary
Added admin role system (role field on User model, requireAdmin() helper, admin user management API), Next.js middleware for server-side route protection, and river analytics API. 885 web tests pass.

## Work Performed
- Added `role` field to User model (Prisma canonical, SQLAlchemy mirror). Values: `"user"` (default), `"admin"`. Role propagated through JWT callback → session callback
- Created `requireAdmin()` helper in `web/src/lib/admin.ts` — checks session role, returns 401/403 NextResponse
- Built admin user management API: list users, update user roles. Self-demotion prevention (admins cannot remove their own admin role)
- Created `web/src/middleware.ts` using NextAuth.js v5's `auth()` wrapper for server-side route protection — replaces client-side-only AuthGuard as primary gate
- Protected routes redirect to `/auth/signin?callbackUrl=...`; admin routes redirect non-admins to `/`
- Built river analytics API at `GET /api/rivers/[id]/analytics` — flow trends, quality distribution, best time to visit, reviews aggregate, visit count. All five queries run in parallel
- Analytics endpoint is public (no auth) matching existing GET river patterns

## Files Touched
- `web/prisma/schema.prisma` (role field on User)
- `web/src/lib/admin.ts` (requireAdmin helper)
- `web/src/app/api/admin/users/route.ts` (list users)
- `web/src/app/api/admin/users/[id]/route.ts` (update user role)
- `web/src/middleware.ts` (server-side route protection)
- `web/src/app/api/rivers/[id]/analytics/route.ts` (river analytics)
- `pipeline/models/models.py` (role field mirror)

## Decisions Filed
- BD-037: Admin Role System — JWT-Based Role Propagation
- BD-038: Next.js Middleware for Server-Side Route Protection
- BD-039: River Analytics API — Query-Time Aggregation
